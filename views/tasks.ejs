<!DOCTYPE html>
<html>
  <head>
    <title>My Memo - Tasks</title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head> 
  <body class="task-display-pg">
    <% include header %>
    <div class="search-bar">

    </div>
    <!-- All tasks list -->
    <div class="task-container-all">
        <div class="task-header-all">
            <h1 class="center">Tasks Left (Total)</h1>
            <p class="task-title-header">Task</p>
            <p class="task-date-header">Finish By</p>
        </div>
        <div class="task-content-all">
            <% for (var i = 0; i < tasklist.length; i++) { %>
                <% if (!tasklist[i].inProg) { %>
                    <div class="task-singular-container" data-task-inProg="false" data-task-id="<%= tasklist[i].id %>" data-task-description="<%= tasklist[i].description %>">
                        <button class="btn-delete"><i class="fas fa-minus-circle"></i></button>
                        <button class="btn-edit"><i class="fas fa-pencil-alt"></i></button>
                        <p class="task-title"><%= tasklist[i].title %></p>
                        <% if (tasklist[i].finishBy) { %>
                        <p class="task-date"><%= new Date(tasklist[i].finishBy + " PST").toDateString() %></p>
                        <% } else { %>
                        <p class="task-date">N/A</p>
                        <% } %>
                        <i class="fas fa-arrows-alt-v btn-task-switcher"></i>
                    </div>
                <% } %>
            <% } %>
        </div>
        <div class="task-singular-container">
            <a href=# class="add-task-all">Add a task</a>
        </div>
    </div>
    <!-- Daily task list-->
    <div class="task-container-day">
        <div class="task-header-day">
            <h1 class="center">Tasks For the Day</h1>
            <p class="task-title-header">Task</p>
            <p class="task-date-header">Finish By</p>
        </div>
        <div class="task-content-day">
            <% for (var i = 0; i < tasklist.length; i++) { %>
                <% if (tasklist[i].inProg) { %>
                    <div class="task-singular-container" data-task-inProg="true" data-task-id="<%= tasklist[i].id %>" data-task-description="<%= tasklist[i].description %>">
                        <button class="btn-delete"><i class="fas fa-minus-circle"></i></button>
                        <button class="btn-edit"><i class="fas fa-pencil-alt"></i></button>
                        <p class="task-title"><%= tasklist[i].title %></p>
                        <% if (tasklist[i].finishBy) { %>
                        <p class="task-date"><%= new Date(tasklist[i].finishBy + " PST").toDateString() %></p>
                        <% } else { %>
                        <p class="task-date">N/A</p>
                        <% } %>
                        <i class="fas fa-arrows-alt-v btn-task-switcher"></i>
                    </div>
                <% } %>
            <% } %>
         </div>
         <div class="task-singular-container">
            <a href=# class="add-task-day">Add a task</a>
        </div>
    </div>

    <!-- Add task modal -->
    <div class="add-modal-container">
        <div class="add-task-container">

            <button class="close-form"><a href=#>X</a></button>
            <h2 class="center">Add a Task</h2>

            <form class="add-task-form">
                <label class="prettylabel" for="task-title">Title:</label><br/>
                <input class="form-element"  id="task-title" type="text" name="title" placeholder="Title of Task" maxlength="40" required/><br/>
                <label class="prettylabel" for="task-desc">Description:</label><br/>
                <textarea class="form-element" id="task-desc" rows="5" cols="40" placeholder="Description (Optional)" maxlength="200"></textarea><br/>
                <label class="prettylabel" for="task-date">Finish by:</label><br/>
                <input class="form-element" id="task-date" type="date" name="finishBy"/><br/>

                <input class="btn-form-submit" type="reset" value="Clear"/>
                <input class="btn-form-submit" type="submit" value="Add"/>
            </form>
        </div>

        <div class="modal-background"></div>
    </div>

    <!-- Edit task modal -->
    <div class="edit-modal-container">
        <div class="edit-task-container">

            <button class="close-form"><a href=#>X</a></button>
            <h2 class="center">Edit Task</h2>

            <form class="edit-task-form">
                <label class="prettylabel" for="edit-task-title">Title:</label><br/>
                <input class="form-element"  id="edit-task-title" type="text" name="title" placeholder="Title of Task" maxlength="40" required/><br/>
                <label class="prettylabel" for="edit-task-description">Description:</label><br/>
                <textarea class="form-element" id="edit-task-description" rows="5" cols="40" placeholder="Description (Optional)" maxlength="200"></textarea><br/>
                <label class="prettylabel" for="edit-task-date">Finish by:</label><br/>
                <input class="form-element" id="edit-task-date" type="date" name="finishBy"/><br/>

                <input class="btn-form-submit" type="reset" value="Clear"/>
                <input class="btn-form-submit" type="submit" value="Save"/>
            </form>
        </div>

        <div class="modal-background"></div>
    </div>
    

    <script src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script>
        // Form data references
        const title       = $('#task-title');
        const description = $('#task-desc');
        const finishBy    = $('#task-date');
        const editTitle       = $('#edit-task-title');
        const editDescription = $('#edit-task-description');
        const editFinishBy    = $('#edit-task-date');
        const addTaskForm = $('.add-task-form');
        const editTaskForm= $('.edit-task-form');
        const modalContain= $('.add-modal-container');
        const editModal   = $('.edit-modal-container');
        const addTaskAll  = $('.add-task-all');
        const addTaskDay  = $('.add-task-day');
        const taskPage    = $('.task-display-pg');

        taskPage.on('click', '.btn-delete', function (e) {
            const id = $(this).parent().attr('data-task-id');
            const button = $(this);

            $.ajax({
                method: 'DELETE',
                url: `/tasks/${id}`
            })
            .done(function(response) {
                button.parent().remove();
            })
            .fail(function(err) {
                console.log(err);
            });
        });
        taskPage.on('click', '.btn-task-switcher', function (e) {
            const id = $(this).parent().attr('data-task-id');
            const inProg = $(this).parent().attr('data-task-inProg');
            const button = $(this);

            $.ajax({
                method: 'PATCH',
                url: `/tasks/${id}/inProg`,
                data: {
                    inProg: inProg
                }
            })
            .done(function(response) {
                const description = button.parent().attr('data-task-description');
                const finishBy    = button.siblings('.task-date').html();
                const title       = button.siblings('.task-title').html();
                button.parent().remove();
                // add task to other container
                let allOrDay = 'day'
                if (inProg === 'true') {
                    allOrDay = 'all';
                }
                addTask(title, finishBy, description, id, allOrDay);
            })
            .fail(function(err) {
                console.log(err);
            });
        });
        taskPage.on('click', '.btn-edit', function(e) {
            const button     = $(this);
            const id         = button.parent().attr('data-task-id');
            const title      = button.siblings('.task-title').html();
            const description= button.parent().attr('data-task-description');
            const finishBy   = button.siblings('.task-date').html();
            editTaskForm.attr('form-task-id', id)

            $('#edit-task-title').val(title);
            $('#edit-task-description').val(description);
            if (finishBy !== 'N/A')
                $('#edit-task-date').val(new Date(finishBy).toISOString().substr(0,10));
            else
                $('#edit-task-date').val('');
            editModal.addClass('show');
        });
        addTaskAll.click(function(e) {
            modalContain.addClass('show');
            addTaskForm.attr('day', 'false');
        });
        addTaskDay.click(function(e) {
            modalContain.addClass('show');
            addTaskForm.attr('day', 'true');
        });
        modalContain.on('click', '.modal-background', function(e) {
            modalContain.removeClass('show');
        });
        $(".add-task-container").on('click', '.close-form', function(e) {
			modalContain.removeClass('show');
        });
        editModal.on('click', '.modal-background', function(e) {
            editModal.removeClass('show');
        });
        $(".edit-task-container").on('click', '.close-form', function(e) {
			editModal.removeClass('show');
        });
        addTaskForm.submit(function(e) {
            e.preventDefault();
            var formData = {
                title   : title.val(),
                desc    : description.val(),
                finishBy: finishBy.val(),
                inProg  : addTaskForm.attr('day')
            };
            $.ajax({
                method: 'POST',
                url:    '/tasks',
                data:   formData
            })
            .done(function(newTask) {
                let allOrDay = 'all'
                if (formData.inProg === 'true') {
                    allOrDay = 'day';
                }
                if (newTask.finishBy) {
                    newTask.finishBy = new Date(newTask.finishBy + " PST").toDateString();
                }
                else {
                    newTask.finishBy = "N/A";
                }
                addTask(newTask.title, newTask.finishBy, newTask.description, newTask.id, allOrDay);
                modalContain.removeClass('show');
                clearTaskForm();
            })
            .fail(function(err) {
                console.log(err);
            });
        });
        editTaskForm.submit(function(e) {
            e.preventDefault();
            const id = $(this).attr('form-task-id');
            var formData = {
                title   : editTitle.val(),
                desc    : editDescription.val(),
                finishBy: editFinishBy.val(),
            };
            $.ajax({
                method: 'PATCH',
                url:    `/tasks/${id}`,
                data:   formData
            })
            .done(function(response) {
                // Dynamically redisplay task container contents
                if (formData.finishBy) {
                    formData.finishBy = new Date(formData.finishBy + " PST").toDateString();
                }
                else {
                    formData.finishBy = "N/A";
                }
                const task = $(`div[data-task-id=${id}]`)
                task.children('.task-title').html(formData.title);
                task.children('.task-date').html(formData.finishBy);
                task.attr('data-task-description', formData.desc);

                editModal.removeClass('show');
            })
            .fail(function(err) {
                console.log(err);
            });
        });

        var addTask = (title, date, description, id, allOrDay) => {
            let inProg = "true";
            if (allOrDay === "all")
                inProg = "false";
            $(`.task-content-${allOrDay}`).append(
            `<div class="task-singular-container" data-task-inProg=${inProg} data-task-id="${id}" data-task-description="${description}">
                <button class="btn-delete"><i class="fas fa-minus-circle"></i></button>
                <button class="btn-edit"><i class="fas fa-pencil-alt"></i></button>
                <p class="task-title">${title}</p>
                <p class="task-date">${date}</p>
                <i class="fas fa-arrows-alt-v btn-task-switcher"></i>
            </div>`);
        };

        var clearTaskForm = () => {
            title.val('');
            description.val('');
            finishBy.val('');
        };
    </script>
  </body>
</html>